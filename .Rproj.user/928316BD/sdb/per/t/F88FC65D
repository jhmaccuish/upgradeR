{
    "collab_server" : "",
    "contents" : "###############################################\n#       Main R Code for upgrade project\n#   Author : Jamie Hentall MacCuish\n###############################################\n#cat(\"\\014\") # this clears the console window (clc in Matlab)\nrm(list=ls()) # this clears the data space (clear all in Matlab)\n\n#library(foreign) \nlibrary(np) # load the package \"np\"\nlibrary(plyr)\nlibrary(haven)\nlibrary(dplyr)\nlibrary(sfsmisc)\nlibrary(sampleSelection)\n\nnumPercentiles <- 4\nPercentilePoints <- seq(0,1,length.out= numPercentiles+1)\nstartAge <- 57\nendAge <- 57\nq <- array(0,c((endAge-startAge+1),numPercentiles,numPercentiles))\np <- array(NA,c((endAge-startAge+1),8,numPercentiles,numPercentiles))\n\ncleaned_data_waves1_8 <- read_dta(\"../Stata/data/cleaned_data_waves1-8.dta\")\ncleaned_data_waves1_8 <- cleaned_data_waves1_8[(cleaned_data_waves1_8$female == 1  ),]\n\nheck <- selection( wpactive  ~ age + over_SPA + marstat,\n                   individual_net_emp_inc ~ age +tenure + edu_yr + gor, cleaned_data_waves1_8 )\ncleaned_data_waves1_8$y_fitted <- predict( heck )\n\n\nfor(currentAge in 57:57) {\n\n  newTest <- cleaned_data_waves1_8[,c('idauniq','age','bu_non_housing_wlth','wpactive','year_age_SPA','y_fitted')]\n  newTest <- newTest[(newTest$idauniq != 150791),]\n  newTest <- newTest[((newTest$age==currentAge | newTest$age==(currentAge+1)) &  !is.na(newTest$bu_non_housing_wlth)),]\n  newTest <- newTest[order(newTest$idauniq,newTest$age),]\n  \n  leadData <- newTest %>% group_by(idauniq) %>% mutate( wlth1= lead(bu_non_housing_wlth, n = 1L, default = NA, order_by = age))\n  \n  countdata <- plyr::count(newTest, vars = c(\"idauniq\"))\n  \n  deciles1 <- quantile(newTest[(newTest$age==currentAge),]$bu_non_housing_wlth, probs = PercentilePoints,na.rm=TRUE)\n  deciles2 <- quantile(newTest[(newTest$age==(currentAge+1)),]$bu_non_housing_wlth, probs = PercentilePoints,na.rm=TRUE)\n  \n  \n  countdata <- countdata[(countdata$freq==2),]\n  \n  leadData <- leadData[(leadData$idauniq %in% countdata$idauniq),]\n  fiter <- function (wealth,age,percentile,selectAge) {\n     for (i in 1:length(percentile)){\n      if (wealth<percentile[i]){return(i)} \n     }\n  }\n  \n  leadData <- mutate( leadData, d1=fiter(bu_non_housing_wlth,age,deciles1))\n  leadData <- mutate( leadData, d12=fiter(wlth1,age,deciles2))\n  leadData <- leadData[(leadData$age==currentAge),]\n  for (i in 2:(numPercentiles+1)) {\n    #print(cat(\"Current Conditioning Decile\", i))\n    #print(nrow(leadData[(leadData$d1==i),]))\n    hist(leadData[(leadData$d1==i),]$d12, xlim=c(1,numPercentiles+1) ,breaks = seq(1,numPercentiles+1,1), \n         main=paste(\"Age =\",currentAge,\"Income decile =\", (i-1),\"Observations =\",nrow(leadData[(leadData$d1==i),])))\n    #Sys.sleep(2)\n    #kde2d\n    den = density(leadData[(leadData$d1==i),]$wlth1)\n    #plot(den, main=paste(\"Age =\",currentAge,\"Income decile =\", (i-1),\"Observations =\",nrow(leadData[(leadData$d1==i),])))\n    #abline(v=deciles2)\n    #Sys.sleep(2)\n    #readline(prompt=\"Press [enter] to continue\")\n    q[currentAge-startAge+1,i-1,1] <- integrate.xy(den$x[(den$x<=deciles2[2])],den$y[(den$x<=deciles2[2])])    \n    for (j in 3:(numPercentiles+1)){\n      if (length(den$x[(deciles2[j-1]<den$x & den$x<=deciles2[j])])>0){\n      q[currentAge-startAge+1,i-1,j-1] <- integrate.xy(den$x[(deciles2[j-1]<den$x & den$x<=deciles2[j])],den$y[(deciles2[j-1]<den$x & den$x<=deciles2[j])])\n      }\n    }\n    if (length(den$x[(deciles2[j]<den$x)])>0){\n      q[currentAge-startAge+1,i-1,j-1] <- integrate.xy(den$x[(deciles2[j]<den$x)],den$y[(deciles2[j]<den$x)])\n    }    \n    #print(cat(\"Sum CCPs\", sum(q[currentAge-startAge+1,i-1,])))\n    q[currentAge-startAge+1,i-1,] <- q[currentAge-startAge+1,i-1,]/sum(q[currentAge-startAge+1,i-1,])\n    #print(cat(\"Sum Corrected CCPs\", sum(q[currentAge-startAge+1,i-1,])))\n    print(q[currentAge-startAge+1,i-1,])\n    readline(prompt=\"Press [enter] to continue\")\n    for (ageSPA in 60:67) {\n      if (nrow(leadData[(leadData$d1==i & leadData$year_age_SPA==ageSPA),])>1) {\n        hist(leadData[(leadData$d1==i & leadData$year_age_SPA==ageSPA),]$d12, xlim=c(1,numPercentiles+1) ,breaks = seq(1,numPercentiles+1,1), \n             main=paste(\"Age =\",currentAge,\"Income decile =\", (i-1),\"SPA Age =\",ageSPA))\n        den = density(leadData[(leadData$d1==i & leadData$year_age_SPA==ageSPA),]$wlth1)\n        p[currentAge-startAge+1,ageSPA-59,i-1,1] <- integrate.xy(den$x[(den$x<=deciles2[2])],den$y[(den$x<=deciles2[2])])    \n        for (j in 3:(numPercentiles+1)){\n          if (length(den$x[(deciles2[j-1]<den$x & den$x<=deciles2[j])])>0){\n            p[currentAge-startAge+1,ageSPA-59,i-1,j-1] <- integrate.xy(den$x[(deciles2[j-1]<den$x & den$x<=deciles2[j])],den$y[(deciles2[j-1]<den$x & den$x<=deciles2[j])])\n          }\n          else {p[currentAge-startAge+1,ageSPA-59,i-1,j-1] = 0}\n        }\n        if (length(den$x[(deciles2[j]<den$x)])>0){\n          p[currentAge-startAge+1,ageSPA-59,i-1,j-1] <- integrate.xy(den$x[(deciles2[j]<den$x)],den$y[(deciles2[j]<den$x)])\n        }        \n      }\n      #readline(prompt=\"Press [enter] to continue\")\n    }\n  }\n}",
    "created" : 1525597730065.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2320013498",
    "id" : "F88FC65D",
    "lastKnownWriteTime" : 1526234917,
    "last_content_update" : 1526234917743,
    "path" : "~/Dropbox/SourceCode/upgradeProject/R/Main.R",
    "project_path" : "Main.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}